<html><head><link rel="import" href="../../../bower_components/google-map/google-map.html"><link rel="import" href="../../../bower_components/google-map/google-map-marker.html"><link rel="import" href="../../../bower_components/paper-input-place/paper-input-place.html"><link rel="import" href="../../../bower_components/paper-card/paper-card.html"><link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html"><link rel="import" href="../../../bower_components/paper-button/paper-button.html"><link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html"><link rel="import" href="../../../bower_components/paper-fab/paper-fab.html"><link rel="import" href="../../../bower_components/paper-item/paper-item.html"><link rel="import" href="../../../bower_components/paper-item/paper-item-body.html"><link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html"><link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html"><link rel="import" href="../../../bower_components/bwt-datatable/bwt-datatable-card.html"><link rel="import" href="../../../bower_components/bwt-datatable/bwt-datatable-column.html"><link rel="import" href="../../../bower_components/bwt-datatable/bwt-datatable.html"><link rel="import" href="../../../bower_components/polymate/polymate-view.html"><link rel="import" href="../../../bower_components/vaadin-time-picker/vaadin-time-picker.html"><script type="text/javascript" src="../../../bower_components/moment/min/moment.min.js"></script><link rel="import" href="../../elements/my-icons.html"><link rel="import" href="../../elements/base-class.html"></head><body><dom-module id="page-order-service"><template><style include="iron-flex iron-flex-alignment">:host{display:block;}#map{width:100%;height:430px;}.place-picker{display:block;margin:auto;width:400px;margin-top:-15px;margin-left:10px;}.card{display:block;width:100%;margin-top:24px;}#container{margin-left:24px;margin-right:24px;margin-bottom:72px;}.look{background:var(--primary-color);color:white;margin:8px;margin-right:0;float:right;}paper-fab{position:sticky;bottom:48px;float:right;right:48px;}#animation{width:400px;height:400px;}</style><paper-dialog id="dialogLooking" entry-animation="scale-up-animation" exit-animation="fade-out-animation" modal="" on-iron-overlay-opened="patchOverlay"><h2>Looking For a driver, Please Wait...</h2><div><polymate-view id="animation" path="../../../images/looking.json" autoplay="" loop=""></polymate-view></div><div class="buttons"><paper-button on-click="onCancelClicked">Cancel Request</paper-button></div></paper-dialog><paper-dialog id="dialogDriver" entry-animation="scale-up-animation" exit-animation="fade-out-animation" modal="" on-iron-overlay-opened="patchOverlay"><h2>Driver Accepted</h2><p>Driver Name: [[driver.first_name]] [[driver.last_name]]</p><p>Mobile Number: [[driver.mobile_number]]</p><div class="buttons"><paper-button dialog-confirm="">GOOD!</paper-button></div></paper-dialog><div id="container" class="col-md-12"><paper-card id="cardLocation" class="card" heading="Where &amp; When..."><google-map id="map" api-key="[[apiKey]]" draggable="true" styles="[[style]]" latitude="37.4219" longitude="-122.0862" zoom="15" drag-events="" google-map-drag="onMapDragend"><google-map-marker slot="markers" icon="../../../images/marker_pickup.png" style="width: 150px; height:150px" latitude="{{pickupLatLng.lat}}" longitude="{{pickupLatLng.lng}}" draggable="true"></google-map-marker><google-map-marker slot="markers" icon="../../../images/marker_destination.png" latitude="{{destinationLatLng.lat}}" longitude="{{destinationLatLng.lng}}" draggable="true"></google-map-marker></google-map><div class="row"><div class="col-md-6"><paper-radio-group id="groupLocation" selected="pickup"><paper-radio-button name="pickup"><div class="row" style="display: flex; align-items: baseline"><img src="../../../images/marker_pickup.png"><paper-input-place id="textPickup" class="place-picker" place="{{place}}" api-key="[[apiKey]]" label="Pick pickup location" hide-error="" hide-icon=""></paper-input-place></div></paper-radio-button><paper-radio-button name="destination"><div class="row" style="display: flex; align-items: baseline"><img src="../../../images/marker_destination.png"><paper-input-place id="textDestination" class="place-picker" place="{{place}}" api-key="[[apiKey]]" label="Pick destination" hide-error="" hide-icon=""></paper-input-place></div></paper-radio-button></paper-radio-group></div><div class="col-md-6 layout horizontal"><paper-checkbox id="checkLater" checked="{{bookLater}}" style="margin: 16px; margin-top: 40px">Book For Later</paper-checkbox><vaadin-time-picker id="timePicker" style="margin-bottom: 16px" label="Expected Time" hidden="[[!bookLater]]"></vaadin-time-picker></div></div></paper-card><paper-card id="cardServices" class="card" heading="Select Services"><div class="card-content"><paper-listbox selected="{{selectedServiceId}}" attr-for-selected="value" style="overflow-y: scroll; max-height: 400px;"><template is="dom-repeat" items="{{services}}"><paper-item value="[[item.id]]" role="menuitemcheckbox"><iron-image sizing="contain" style="margin-right: 16px" preload="" width="80" height="50" src="[[getImageAddressFromMedia(item.media)]]"></iron-image><paper-item-body two-line=""><div>[[item.title]]</div><div secondary="">Base Fare: [[item.base_fare]] Per 100m: [[item.per_hundred_meters]]</div></paper-item-body></paper-item></template></paper-listbox></div></paper-card><paper-datatable-card id="cardUsers" class="card" header="Rider To Assign" data-source="{{data}}" page-size="10" id-property="id" selected-ids="{{selectedIds}}"><div slot="toolbar-main"><paper-input value="{{searchTerm}}" on-input="refreshList" label="{{localize('table-search')}}" style="display:inline-block" no-label-float=""><div slot="prefix"><iron-icon icon="search"></iron-icon></div></paper-input><paper-icon-button icon="cached" on-tap="refreshList"></paper-icon-button></div><div slot="toolbar-select"></div><div slot="toolbar-select-single"></div><paper-datatable id="datatable" selectable="" on-row-tap="rowTapped"><div slot="no-results">{{localize('table-loading')}}</div><paper-datatable-column header="{{localize('column-id')}}" property="id"></paper-datatable-column><paper-datatable-column header="{{localize('column-first-name')}}" property="first_name"></paper-datatable-column><paper-datatable-column header="{{localize('column-last-name')}}" property="last_name"></paper-datatable-column><paper-datatable-column header="{{localize('column-mobile-number')}}" property="mobile_number"></paper-datatable-column><paper-datatable-column header="{{localize('column-balance')}}" property="balance" format-value="{{moneyFormatter}}"></paper-datatable-column><paper-datatable-column header="{{localize('column-address')}}" property="address"></paper-datatable-column></paper-datatable></paper-datatable-card><paper-card class="card"></paper-card></div><paper-fab icon="search" on-click="searchClicked"></paper-fab></template><script>let orderServicePage;class PageOrderService extends BaseClass{static get is(){return"page-order-service"}static get properties(){return{apiKey:{type:String,value:function(){return localStorage.getItem("map")}},markers:Array,pickupLatLng:{type:Object,value:{lat:37.4219,lng:-122.0862}},destinationLatLng:{type:Object,value:{lat:37.4269,lng:-122.0822}},pickupLocation:String,driver:Object,bookLater:Boolean,destinationLocation:String,services:Array,selectedServiceId:Number,style:{type:Array,value:function(){return mapStyle}},place:{type:Object,notify:!0/* ignoreName */ /* skipSlots */},data:{type:Object,value:{get:function(sort,page,pageSize){return app.getRows(orderServicePage,"rider",{},sort,page,pageSize,["mobile_number"],orderServicePage.searchTerm?orderServicePage.searchTerm:"")},set:function(item,property,value){return app.setColumnValue("rider",item.id,property,value)},length:0}},selectedIds:Array,searchTerm:String}}attached(){super.attached();orderServicePage=this;this.addEventListener("place-changed",function(item){let latLng=item.detail.value.latLng;if(null==latLng)return;if("destination"==this.$.groupLocation.selected){this.set("destinationLatLng",latLng);this.set("destinationLocation",item.detail.value.formatted_address)}else{this.set("pickupLatLng",latLng);this.set("pickupLocation",item.detail.value.formatted_address)}this.$.map.fitToMarkers=/* ignoreName */!1/* skipSlots */ /* skipSlots */;this.$.map.fitToMarkers=!0});this.getRows(this,"service",{},{property:"id",direction:"asc"},1,100,[],"").then(function(result){this.set("services",result)}.bind(this));socket.on("driverAccepted",function(driver){this.$.dialogLooking.close();this.set("driver",driver);this.$.dialogDriver.open()}.bind(this))}rowTapped(ev){if(this.isDebouncerActive("dblclick"+ev.detail.item.id)){ev.preventDefault();this.$.dataTableCard.deselectAll();this.$.dataTableCard.select(ev.detail.item.id);this.onEditItem();this.cancelDebouncer("dblclick")}else{this.debounce("dblclick"+ev.detail.item.id,function(){},300)}}searchClicked(){if(!this.pickupLocation){app.showErrorMessage("Pickup Location is not selected.");this.$.cardLocation.scrollIntoView();this.$.textPickup.focus();return}if(!this.destinationLocation){app.showErrorMessage("Destination Location is not selected.");this.$.cardLocation.scrollIntoView();this.$.textPickup.focus();return}if(this.selectedServiceId==void 0){app.showErrorMessage("No Service is selected.");this.$.cardServices.scrollIntoView();return}if(1!=this.selectedIds.length){app.showErrorMessage("No Rider Selected to Assign Travel to.");this.$.cardUsers.scrollIntoView();return}let minutesFromNow=0;if(this.$.checkLater.checked){if(!this.$.timePicker.value){app.showErrorMessage("You have selected book for later but didn't set time.");this.$.timePicker.scrollIntoView();return}let end=moment(this.$.timePicker.value,"hh:mm");var duration=moment.duration(end.diff(moment()));minutesFromNow=Math.ceil(duration.asMinutes());if(0>minutesFromNow){app.showErrorMessage("Time selected for later booking can't be past now!");this.$.timePicker.scrollIntoView();return}}socket.emit("requestService",{x:this.pickupLatLng.lng,y:this.pickupLatLng.lat},//Pickup LatLng in {x,y} format
{x:this.destinationLatLng.lng,y:this.destinationLatLng.lat},this.pickupLocation,this.destinationLocation,this.selectedServiceId,this.selectedIds[0],minutesFromNow,function(statusCode,result){switch(statusCode){case 200:if(this.$.checkLater.checked){app.showErrorMessage("Your Travel Has been booked. A call will be made to all drivers close 30 minutes before expected time.")}else{this.$.dialogLooking.open()}/*this.pickupLocation = ''
                this.destinationLocation = ''
                this.selectedServiceId = null
                this.$.cardUsers.deselectAll()
                this.$.textPickup.value = ''
                this.$.textDestination.value = ''
                this.$.groupLocation.selected = 'pickup'
                this.$.checkLater.checked = false
                this.$.cardLocation.scrollIntoView()*/break;case 404:app.showErrorMessage("No Online Close Driver Found");break;case 303:app.showErrorMessage("No Online Close Driver has Found corresponding service selected.");break;default:app.showErrorMessage("An error with code "+statusCode+": "+result);}}.bind(this))}onCancelClicked(){socket.emit("cancelRequest",function(){this.$.dialogLooking.close()}.bind(this))}refreshList(ev){this.$.cardUsers.retrieveVisibleData()}}customElements.define(PageOrderService.is,PageOrderService);</script></dom-module></body></html>